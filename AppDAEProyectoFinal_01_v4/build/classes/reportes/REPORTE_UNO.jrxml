<?xml version="1.0" encoding="UTF-8"?>
<jasperReport xmlns="http://jasperreports.sourceforge.net/jasperreports" xmlns:xsi="http://www.w3.org/2001/XMLSchema-instance" xsi:schemaLocation="http://jasperreports.sourceforge.net/jasperreports http://jasperreports.sourceforge.net/xsd/jasperreport.xsd" name="REPORTE_UNO" language="groovy" pageWidth="595" pageHeight="842" columnWidth="555" leftMargin="20" rightMargin="20" topMargin="20" bottomMargin="20" uuid="c31858e4-d597-4963-83da-abe79215f3e0">
	<property name="ireport.zoom" value="1.1"/>
	<property name="ireport.x" value="0"/>
	<property name="ireport.y" value="626"/>
	<subDataset name="EstadoSaludDataset" uuid="8c5fd89b-953a-4605-82cd-af73d6888515">
		<queryString language="SQL">
			<![CDATA[SELECT
     COUNT(*) AS numero_mascotas,
     M."estado_salud"
FROM
     "mascota" M
WHERE
     M.vigencia = TRUE
GROUP BY
     M.estado_salud]]>
		</queryString>
		<field name="numero_mascotas" class="java.lang.Long"/>
		<field name="estado_salud" class="java.lang.String"/>
		<group name="estado_salud">
			<groupExpression><![CDATA[$F{estado_salud}]]></groupExpression>
		</group>
	</subDataset>
	<queryString>
		<![CDATA[SELECT
    D.doc_identidad AS documento_identidad_dueno,
    D.nombres || ' ' || D.apePaterno || ' ' || D.apeMaterno AS nombre_dueno,
    D.telefono AS contacto,
    M.nombre AS nom_ma,
	d.id as idDueno,
    M.estado_salud AS estado_salud,
    CASE
        WHEN M.estado_salud = 'T' THEN 'Terminal'
        WHEN M.estado_salud = 'C' THEN 'Cronico'
        WHEN M.estado_salud = 'S' THEN 'Saludable'
    END AS clasi_salud,
    CASE
        WHEN M.esterilizado=true THEN 'Si'
        WHEN M.esterilizado=false THEN 'No'
    END AS est,
	CASE
        WHEN M.desparasitado=true THEN 'Si'
        WHEN M.desparasitado=false THEN 'No'
    END AS desp,
    COUNT(M.id) OVER(PARTITION BY D.id) AS cantidad_mascotas,

    case
	when M.vigencia = true then 'Vigente'
	when M.vigencia = false then 'No Vigente'
	end as vigencia,
   ra.nombre, ES.NOMBRE as esp_nom
FROM
    CUSTODIA C
JOIN
    DUEniO D ON C.DUEniOid = D.id
JOIN
    MASCOTA M ON C.MASCOTAid = M.id
JOIN
    RAZA RA ON M.RAZA_ID=RA.ID
JOIN
   ESPECIE ES ON RA.ESPECIE_ID=ES.ID
WHERE
    D.vigencia = TRUE

ORDER BY
    d.id, m.id]]>
	</queryString>
	<field name="documento_identidad_dueno" class="java.lang.String"/>
	<field name="nombre_dueno" class="java.lang.String"/>
	<field name="contacto" class="java.lang.String"/>
	<field name="nom_ma" class="java.lang.String"/>
	<field name="iddueno" class="java.lang.Integer"/>
	<field name="estado_salud" class="java.lang.String"/>
	<field name="clasi_salud" class="java.lang.String"/>
	<field name="est" class="java.lang.String"/>
	<field name="desp" class="java.lang.String"/>
	<field name="cantidad_mascotas" class="java.lang.Long"/>
	<field name="vigencia" class="java.lang.String"/>
	<field name="nombre" class="java.lang.String"/>
	<field name="esp_nom" class="java.lang.String"/>
	<group name="idDueno">
		<groupExpression><![CDATA[$F{iddueno}]]></groupExpression>
		<groupHeader>
			<band height="68">
				<textField>
					<reportElement x="0" y="0" width="555" height="39" uuid="7f45026e-578b-426f-a100-7d9b9a08e672"/>
					<textFieldExpression><![CDATA["Dueño: " + $F{nombre_dueno} + " (DNI: " + $F{documento_identidad_dueno} + ")" +
"\nTeléfono: " + $F{contacto} +
"\nTotal Mascotas: " + $F{cantidad_mascotas}]]></textFieldExpression>
				</textField>
				<line>
					<reportElement x="0" y="49" width="555" height="1" uuid="22a477d2-2069-492d-9286-1894f5ab2e7f"/>
				</line>
				<staticText>
					<reportElement x="0" y="49" width="47" height="15" uuid="402facb8-882d-4956-9e30-41b78158928f"/>
					<text><![CDATA[Mascota]]></text>
				</staticText>
				<staticText>
					<reportElement x="243" y="49" width="57" height="15" uuid="ee4105e5-9249-478d-8159-fcc947568803"/>
					<text><![CDATA[Esterilizado]]></text>
				</staticText>
				<staticText>
					<reportElement x="325" y="49" width="70" height="15" uuid="abfc293b-0a5f-482b-9cc0-d0038982e574"/>
					<text><![CDATA[Desparasitado]]></text>
				</staticText>
				<staticText>
					<reportElement x="167" y="49" width="42" height="15" uuid="f8bc8db5-ed8a-4f1b-a0c7-8395f1cec361"/>
					<text><![CDATA[Vigencia]]></text>
				</staticText>
				<staticText>
					<reportElement x="493" y="49" width="39" height="15" uuid="648f9a2b-e3f1-4113-8786-6a05f4cc57f3"/>
					<text><![CDATA[Especie]]></text>
				</staticText>
				<staticText>
					<reportElement x="418" y="49" width="24" height="15" uuid="66d3822c-92ee-4490-87d2-489cf32ddc35"/>
					<text><![CDATA[Raza]]></text>
				</staticText>
				<staticText>
					<reportElement x="67" y="49" width="67" height="15" uuid="52c2387e-616b-439e-8bed-7a0134a52729"/>
					<text><![CDATA[Estado Salud]]></text>
				</staticText>
				<line>
					<reportElement x="0" y="64" width="555" height="1" uuid="616c9b92-04c8-4aee-ac5b-1be2aecdf5d9"/>
				</line>
			</band>
		</groupHeader>
	</group>
	<title>
		<band height="69" splitType="Stretch">
			<staticText>
				<reportElement x="0" y="0" width="555" height="32" uuid="7487f534-6f06-4d40-b86d-54270d4c712d"/>
				<textElement textAlignment="Center">
					<font size="20" isBold="true"/>
				</textElement>
				<text><![CDATA[Reporte de mascota por Estado de salud y Dueño]]></text>
			</staticText>
			<staticText>
				<reportElement x="0" y="33" width="555" height="31" uuid="a55166db-1ae5-46db-adb6-5b806e046f71"/>
				<text><![CDATA[Este reporte detalla la relación entre dueños y sus mascotas, clasificando a las mascotas según su dueño, y se detalla el estado de salud (Saludable, Crónico, Terminal) y más informacion relevante de la mascota. ]]></text>
			</staticText>
		</band>
	</title>
	<pageHeader>
		<band height="37" splitType="Stretch">
			<staticText>
				<reportElement x="0" y="0" width="100" height="13" uuid="04534bbe-58fd-42e6-ac54-130c2d32f353"/>
				<text><![CDATA[Veterinaria Marmota]]></text>
			</staticText>
			<line>
				<reportElement x="0" y="0" width="555" height="1" uuid="a4700874-7351-4313-b411-2f705cbdf86f"/>
			</line>
			<line>
				<reportElement x="0" y="14" width="555" height="1" uuid="e8860bfc-1629-44a3-b1f8-715ff007c5ed"/>
			</line>
		</band>
	</pageHeader>
	<detail>
		<band height="19" splitType="Stretch">
			<textField>
				<reportElement x="0" y="0" width="58" height="14" uuid="c0ef3273-5de3-4b35-aaf1-2e941b9bcd32"/>
				<textFieldExpression><![CDATA[$F{nom_ma}]]></textFieldExpression>
			</textField>
			<textField>
				<reportElement x="167" y="0" width="58" height="14" uuid="6303bc8e-f7d6-4a26-b27a-d0422ec153a4"/>
				<textFieldExpression><![CDATA[$F{vigencia}]]></textFieldExpression>
			</textField>
			<textField>
				<reportElement x="243" y="0" width="33" height="14" uuid="c57328b9-3ec8-4fb8-8e8b-f0bb58716b87"/>
				<textFieldExpression><![CDATA[$F{est}]]></textFieldExpression>
			</textField>
			<textField>
				<reportElement x="325" y="3" width="47" height="14" uuid="3052db90-d0c1-4d23-a34f-ea7906e9ed5b"/>
				<textFieldExpression><![CDATA[$F{desp}]]></textFieldExpression>
			</textField>
			<textField>
				<reportElement x="418" y="3" width="58" height="14" uuid="598ae4a3-5418-470b-bef9-8679c2328d94"/>
				<textFieldExpression><![CDATA[$F{nombre}]]></textFieldExpression>
			</textField>
			<textField>
				<reportElement x="493" y="0" width="62" height="14" uuid="5f933fb5-4eb7-40a7-9580-d1b2982fea75"/>
				<textFieldExpression><![CDATA[$F{esp_nom}]]></textFieldExpression>
			</textField>
			<textField>
				<reportElement x="67" y="0" width="79" height="14" uuid="20ff4de2-457e-47fc-92b7-0f07256a3f9c"/>
				<textFieldExpression><![CDATA[$F{clasi_salud}]]></textFieldExpression>
			</textField>
		</band>
	</detail>
	<pageFooter>
		<band height="36" splitType="Stretch">
			<textField>
				<reportElement x="464" y="14" width="91" height="20" uuid="57b34fb8-b3c3-4d1e-ab55-c430ff33df7c"/>
				<textFieldExpression><![CDATA[new java.util.Date()]]></textFieldExpression>
			</textField>
			<staticText>
				<reportElement x="0" y="14" width="167" height="20" uuid="5ddc6aef-7634-407c-a907-d03c23386828"/>
				<textElement>
					<font isBold="true"/>
				</textElement>
				<text><![CDATA[Hecho por: Tirsa Ríos Olazábal]]></text>
			</staticText>
			<textField>
				<reportElement x="243" y="14" width="109" height="20" uuid="f698b73a-8404-4e79-a3bb-ff7c524ff7c3"/>
				<textFieldExpression><![CDATA[$V{PAGE_NUMBER}]]></textFieldExpression>
			</textField>
			<break>
				<reportElement x="0" y="33" width="100" height="1" uuid="676e1529-b078-4654-88c9-9d781de6de9b"/>
			</break>
		</band>
	</pageFooter>
	<lastPageFooter>
		<band height="765">
			<barChart>
				<chart>
					<reportElement x="24" y="59" width="508" height="457" uuid="3d6ccb15-ce2b-45dd-bb31-4555b59b07a7"/>
					<chartTitle/>
					<chartSubtitle/>
					<chartLegend/>
				</chart>
				<categoryDataset>
					<dataset>
						<datasetRun subDataset="EstadoSaludDataset" uuid="41588eff-358b-49dc-8912-29f86edfdf78"/>
					</dataset>
					<categorySeries>
						<seriesExpression><![CDATA[$F{estado_salud}.equals("T") ? "Terminal" :
$F{estado_salud}.equals("C") ? "Crónico" :
$F{estado_salud}.equals("S") ? "Saludable" : "Crítico"]]></seriesExpression>
						<categoryExpression><![CDATA[$F{estado_salud}]]></categoryExpression>
						<valueExpression><![CDATA[$F{numero_mascotas}]]></valueExpression>
					</categorySeries>
				</categoryDataset>
				<barPlot>
					<plot/>
					<itemLabel/>
					<categoryAxisFormat>
						<axisFormat/>
					</categoryAxisFormat>
					<valueAxisFormat>
						<axisFormat/>
					</valueAxisFormat>
				</barPlot>
			</barChart>
			<staticText>
				<reportElement x="0" y="0" width="555" height="45" uuid="a804b2e9-fd1a-4c92-b202-9bfbc3f3151a"/>
				<textElement textAlignment="Justified"/>
				<text><![CDATA[El gráfico de barras ilustra la cantidad de mascotas por cada estado de salud (Saludable, Crónico, Terminal). El eje X representa los estados de salud, mientras que el eje Y muestra el número de mascotas en cada categoría, proporcionando una visualización clara de la distribución de salud general de la Veterinaria Marmota.]]></text>
			</staticText>
			<staticText>
				<reportElement x="10" y="745" width="167" height="20" uuid="a80d9724-c9f3-46cc-a1f1-74d977cd2af7"/>
				<textElement>
					<font isBold="true"/>
				</textElement>
				<text><![CDATA[Hecho por: Tirsa Ríos Olazábal]]></text>
			</staticText>
			<textField>
				<reportElement x="464" y="745" width="91" height="20" uuid="cd94d48d-45ee-4b39-89b3-e59f5da8a4b3"/>
				<textFieldExpression><![CDATA[new java.util.Date()]]></textFieldExpression>
			</textField>
			<textField>
				<reportElement x="243" y="745" width="109" height="20" uuid="be76e60a-892c-47a5-804d-9e7293896c83"/>
				<textFieldExpression><![CDATA[$V{PAGE_NUMBER}]]></textFieldExpression>
			</textField>
		</band>
	</lastPageFooter>
</jasperReport>
